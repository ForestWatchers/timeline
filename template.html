<! -- Fix for Bootstrap css with Google Maps https://github.com/twitter/bootstrap/issues/1552 -->
<style type="text/css">
    .map_canvas label {
        width: auto;
        display: inline;
    }
    .map_canvas img {
        max-width: none;
    }

    #throbber {
        position:absolute;
        z-index: 10000;
        width: 100px;
        height: 100px;
        margin-top: 105px;
        margin-left: 260px;
    }

    .layersDiv label {
        color: white;
    }
    .olControlOverviewMapElement {
        background-color: white;
    }
</style>

<div class="row">
  <!-- Success and Error Messages for the user --> 
  <!-- Question, task id, photo and action buttons for answering the question-->
  <div class="span12" style="height:50px;">
    <div id="success" class="alert alert-success" style="display:none;">
      <a class="close">×</a>
      <strong>Well done!</strong> Your answer has been saved</strong>
    </div>
    <div id="taskcompleted" class="alert alert-info" style="display:none;">
      <strong>The task has been completed!</strong> Thanks a lot!</strong>
    </div>
    <div id="finish" class="alert alert-success" style="display:none;">
      <strong>Congratulations!</strong> You have participated in all available tasks!</strong>
      <br/>
      <div class="alert-actions">
              <a class="btn small" href="/">Go back</a>
              <a class="btn small" href="/app">or, Check other applications</a>
      </div>
    </div>
    <div id="error" class="alert alert-error" style="display:none;">
      <a class="close">×</a>
      <strong>Error!</strong> Something went wrong, please contact the site administrators</strong>
    </div>
    <div id="warning" class="alert alert-warning" style="display:none;">
      <a class="close">×</a>
      <strong>Oooops!</strong> Tile not found, trying with a new one!</strong>
    </div>
  </div>
</div>

<!-- Header of the task -->
<div class="row">
  <div class="skeleton span12">
    <div id="question">
      <h1>Question</h1>
      <!--<h3 id="area">Area</h3>-->
      <p>Task: <span id="task-id" class="label label-warning">#</span></p>
</div>
<!-- Map Canvas -->
          <div id="throbber"></div>
<div id="maps" class="row">
</div>

<script src="/static/openlayers/OpenLayers.js"></script>
<script src="/static/js/throbber/throbber.js"></script>
<script src="/static/js/pybossa/pybossa.js" type="text/javascript"></script>
<!-- PyBossa interface -->
<script>
// Map Server URL
var server = "http://forestwatchers.net/cgi-bin/mapserv"

var totalArea = 0;
// Map options
var options = {
    allowOverlays: true,
    numZoomLevels: 3
}
// Map Array for loading the images
var map = [];

var boxes  = new OpenLayers.Layer.Boxes( "Limits of the tile" );

// Spinner to give feedback to the user when the map is getting loaded or something is taking place in the background
var spinner = new Throbber({ 
    color: 'black',
    size: 90
});
// Array of spinners to show loading progress
var map_spinner = [];
// The spinner is attached to a div overlayed in top of the map. This div is only shown when the spinner is active, 
// otherwise, the div is hidden from the view to show the map.
spinner.appendTo (document.getElementById('throbber'));

// This function shows the spinner div and starts its animation
function spinnerStart() {
    $("#throbber").show();
    spinner.start();
}

// This function stops the spinner and hides the spinner div
function spinnerStop() {
    spinner.stop();
    $("#throbber").hide();
}

// This function creates the map, the layers, and sets up the map
function initializeMaps(tiles) {
    var i=0;
    var n = tiles.length;
    for (i=0;i<n;i++){
        map_div_id = "day-" + tiles[i];
        map[i] = new OpenLayers.Map(map_div_id, {
            controls: [
            //    new OpenLayers.Control.Navigation(),
                new OpenLayers.Control.PanZoomBar(),
            //    new OpenLayers.Control.MousePosition(),
            //    new OpenLayers.Control.ScaleLine(),
            //    new OpenLayers.Control.Attribution()
                ],
            minScale: 240000,
            numZoomLevels: 3,
            unit: 'degrees'
        });

        // Layers
        // Satellite Imagery Map (default layer)
        map[i].addLayer(new OpenLayers.Layer.WMS("Satellite", server, 
        {
            layers: 'satellite',
            //tilesOrigin: map.maxExtent.left + ',' + map.maxExtent.bottom,
            isBaseLayer: true
        }
        ));

        // Add a layer to load a box that represents the limits for the restrictedExtent
        map[i].addLayer(boxes);

        // Add the overviewmap
        //map.addControl(new OpenLayers.Control.OverviewMap(overviewmapOptions));
    }
}

// Initialize the map
//initialize();

// This function will center the map for a given tile
function center(bounds, restrictedExtent, nMaps) {
    // bounds = [left, bottom, right, top]
    // restrictedExtent = [left, bottom, right, top]
    // As this action could take some time, start the spinner
    spinnerStart();
    // Convert the bounds and restrictedExtent to valid OpenLayers objects
    var b = new OpenLayers.Bounds.fromArray(bounds);
    var r = new OpenLayers.Bounds.fromArray(restrictedExtent);
    var a = r.toGeometry();
    totalArea = (a.getGeodesicArea()/1000);
    // Add a box to mark in red the limited restrictedExtent
    var box = new OpenLayers.Marker.Box(r);
    boxes.addMarker(box);
    // Set limits for the map: the user should only see a small fraction of the tile
    var i=0;
    for(i=0;i<nMaps;i++){
        map[i].setOptions({
            maxExtent: r,
            restrictedExtent: r
        })
        map[i].zoomToExtent(r);
    }
    // Stop the spinner as the map has been configured
    spinnerStop();
}

// Load the task data into the HTML skeleton
function loadTask ( task_id ) {
    var t = $.ajax({
        url: '/api/task/'+task_id,
        dataType: 'json'
    });

    t.done( function (task) {
        if ( !$.isEmptyObject(task) ) {
            spinnerStart();
            if (task.state=='completed') {
                $('#controls').hide();
                $('#answer').hide();
                $('#disqus_thread').hide();
                $('#taskcompleted').show();
            }

            // Add divs for the maps
            var tiles = task.info.tile.tiles;
            var l = tiles.length;
            var i = 0;
            var t = Math.floor(12/l);
            for (i=0;i<l;i++) {
                $("#maps").append(
                '<div class="skeleton span' + t + '">' +
                    '<div id="day-' + tiles[i] + '" class="map_canvas" style="width: ' +
                    t*60 + 'px; height: '+ t*60 + 'px;"></div>' + 
                    '<div style="text-align:center; padding-top:5px;"><button class="btn" onclick="submitTask(\'' + tiles[i] + '\')"><i class="icon-ok"></i> This one!</button>' + 
                    '</div> '+ 
                '</div>'
                );
            }

            $("#question h1").text(task.info.question);
            //$("#question h3").text(task.info.tile.name);
            $("#task-id").text(task.id);
            spinnerStop();

            initializeMaps(tiles);

            // Center the map for this task
            center(task.info.tile.bounds, task.info.tile.restrictedExtent, l);
        }
        else {
            $(".skeleton").hide();
            $("#finish").fadeIn();
        }
    });
}

var taskId = pybossa.getCurrentTaskId(window.location.pathname);

if (taskId){
    loadTask(taskId);
}
else {
    pybossa.newTask("besttile").done( function( data ) { 

        if ( !$.isEmptyObject(data.task) ) {
            window.location.pathname = "/app/besttile/task/" + data.task.id;
        }
       else {
            $(".skeleton").hide();
            $("#finish").fadeIn();
        }
    });
}


// Saves the answer for the given task
function submitTask(answer) {
    task_id = $("#task-id").text();

    pybossa.saveTask( task_id, {'besttile': answer}).done( function(data) {
        // Show the feedback div
        $("#success").fadeIn(); 
        // Fade out the pop-up after a 1000 miliseconds
        setTimeout(function() { $("#success").fadeOut() }, 1000);
        // Request a new task
        window.location.pathname = '/app/besttile/newtask';
    });

}
</script>
